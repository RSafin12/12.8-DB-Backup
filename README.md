# 12.8-DB-Backup

### Задание 1. Резервное копирование

### Кейс

Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.
1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.
1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

В данном случае лучше всего будет скомбинировать разные типы бэкапирования. 
Как минимум потребуется создать хотя бы один полный бэкап, например, раз в неделю, например в ночь на понедельник. Ночью обычно пользователи менее активны, поэтому нагрузка должна быть меньше. 
К нему можно добавить ежедневные бэкапы дифференциального типа, 7 шт. для отката на день назад(решение п. 1.1). 
Чтобы иметь возможность откатиться в течении дня можно создать инкрементальные бэкапы, наиболее легковесные(решение п. 1.2). 

В качестве решения п. 1.3 можно настроить репликацию БД. Ранее в лекции про репликацию был описан подход при котором использовался мастер и 2 слейва: синхронный и асинхронный. В случае выхода из строя мастера синхронный слейв становился сразу же мастером, тем самым "подхватив" работу. Ну а асинхронный становится синхронным.  
_____

### Задание 2. PostgreSQL

##### 2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

PostgreSQL обладает удобными инструментами создания дампов. 
pg_dump - программа, создающая целостные копии, даже если БД паралелльно используется, т.е. пользователи в это время имеют доступ на чтение/запись. 
Результатом можем быть скрипт с SQL командами, который воссоздает БД. Скрипт может воссоздать БД на других нодах, при должном старании можно переконвертировать в MySQL.
Синтаксис и примеры 
`pg_dump [параметр-подключения...] [параметр...] [имя_бд]`  синтаксис
**`pg_dump mydb > db.sql `** Выгрузка базы данных mydb в файл SQL-скрипта
**`pg_dump -t mytab mydb > db.sql`** выгрузка отдельной таблицы

pg_restore восстанавливает БД из дампа, созданного командой pg_dump. 
`pg_restore[параметр-подключения...] [параметр...] [имя_файла]
Есть 2 режима использования. При указании имени БД pg_restore подключается к ней и восстанавливает в нее. В ином случае создается SQL скрипт, который пересоздаст БД, который выводится обычно в файл. 
**`pg_restore -C -d postgres db.dump`** восстновит в существущую БД, имя которой записано в архиве файла. 
Можно восстановить в новую БД, просто предварительно ее создав. После можно передать ее имя в pg_restore

Ну и стоит также упомянуть про pg_basebackup, который создает бэкап всего работающего кластера. 

##### 2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?
Конечно, инструментов много. От простого bash скрипта, который будет запускаться по cron'у, до специфичных типа barman, где кол-во и периодичность обновления бэкапа задается в конфиг файле, например в виде
`retention_policy = REDUNDANCY 3`
`last_backup_maximum_age = 4 DAYS` 
_____
### Задание 3. MySQL

##### 3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.
Для решения данной задачи используется бинарный лог, он должен быть включен.   
Посмотреть листинг всех binary log можно командой 
`mysql> SHOW BINARY LOGS;`
Утилита mysqlbinlog конвертирует события из журнала из 2-го формата в текст, что он может быть просмотрен или использован. И повторное использование записей журнала приведет к воссозданию БД.  Команда выглядит так
`mysqlbinlog mysqld-bin.000001 | mysql -u root -p` 
или так, если mysql версии 8(там данные зашифрованы)
`$> mysqlbinlog --read-from-remote-server --host=host_name --port=3306  --user=root --password --ssl-mode=required  binlog_files | mysql -u root -p`

Также можно записать содержимое бин-лога в файл и потом "скормить" его mysql, это удобно, если нужно использовать несколько бин-логов. 
```
$> mysqlbinlog binlog.000001 >  /tmp/statements.sql
$> mysqlbinlog binlog.000002 >> /tmp/statements.sql
$> mysql -u root -p -e "source /tmp/statements.sql"
```
Можно вытащить SQL-запросы из бин-лога
`mysqlbinlog -s mysqld-bin.000001`



_____